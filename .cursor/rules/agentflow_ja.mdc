# AgentFlow 工程規範 (Engineering Rules)

> **バージョン**: 2.1.0
> **更新日**: 2026-01-13
> **適用範囲**: AgentFlow Framework の全コード

---

## 🎯 プロジェクト概要

AgentFlow は軽量 AI エージェント開発フレームワークで、5つのプロトコルを統一インターフェースで提供します。

### 技術スタック

| 項目 | 技術 |
|------|------|
| 言語 | Python 3.13+ |
| Linter | Ruff (line-length=100) |
| 型チェック | Mypy (strict) |
| テスト | Pytest (asyncio, cov≥80%) |
| ビルド | Hatch |

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│  🖥️ 交互層: CLI / API / Studio / WebSocket                      │
├─────────────────────────────────────────────────────────────────┤
│  🔌 サービス層: AgentService, WorkflowService (統一バックエンド) │
├─────────────────────────────────────────────────────────────────┤
│  📱 UI 通信層: AG-UI(SSE), A2UI, WebSocket                      │
├─────────────────────────────────────────────────────────────────┤
│  🤖 Agent層: AgentBlock + Patterns (DeepAgent/Reflection等)    │
├─────────────────────────────────────────────────────────────────┤
│  🔗 協調層: A2A (Agent間通信)                                   │
├─────────────────────────────────────────────────────────────────┤
│  🔧 ツール層: MCP, ToolExecutor                                 │
├─────────────────────────────────────────────────────────────────┤
│  🧠 記憶層: MemoryManager, VectorStore                          │
├─────────────────────────────────────────────────────────────────┤
│  ⚙️ コア層: Registry, Engine, ErrorResponse (RFC 7807)         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📁 ディレクトリ構造

```
agentflow/
├── core/                 # コアモジュール
│   ├── agent_block.py    # Agent基底クラス
│   ├── engine.py         # 実行エンジン
│   ├── exceptions.py     # 例外階層
│   └── error_response.py # RFC 7807 エラー
├── services/             # 統一サービス層
│   ├── base.py           # ServiceBase
│   ├── agent_service.py  # Agent実行
│   └── workflow_service.py # Workflow実行
├── patterns/             # 協調パターン
│   ├── deep_agent.py     # DeepAgentCoordinator（推奨）
│   ├── reflection.py     # ReflectionWorkflow
│   ├── agent_pipeline.py # AgentPipeline
│   └── reflexion.py      # 失敗学習
├── providers/            # 統一Provider
│   ├── llm_provider.py   # LLM
│   └── tool_executor.py  # 並行ツール実行
├── protocols/            # プロトコル実装
│   ├── mcp_client.py     # MCP
│   ├── a2a_*.py          # A2A
│   ├── agui_*.py         # AG-UI
│   └── a2ui/             # A2UI
├── integrations/         # 外部統合
│   ├── websocket_integration.py # WebSocket
│   └── sse_flow_runner.py       # SSE
├── memory/               # 記憶システム
│   ├── memory_manager.py # 3段階記憶
│   └── vector_store.py   # ベクトル検索
├── engines/              # 簡易Engine
│   ├── simple_engine.py
│   ├── pipeline_engine.py
│   └── rag_engine.py
└── skills/               # Skills自動進化
```

---

## 🔧 主要パターン

### 1. DeepAgentCoordinator（推奨）

```python
from agentflow.patterns import DeepAgentCoordinator

coordinator = DeepAgentCoordinator(
    llm_client=llm,
    max_iterations=10,
    quality_threshold=75.0,
    enable_evolution=True,
)
result = await coordinator.execute("複雑なタスク")
```

### 2. 統一サービス層（API/CLI/Studio共通）

```python
from agentflow.services import AgentService, WorkflowService

service = AgentService()

# API向け（結果のみ）
result = await service.execute(agent_id="MyAgent", input_data={...})

# CLI向け（進捗コールバック）
result = await service.execute_with_callback(
    agent_id="MyAgent",
    on_progress=lambda pct, msg: print(f"[{pct:.1f}%] {msg}"),
)

# Studio向け（イベントストリーム）
async for event in service.execute_stream(agent_id="MyAgent"):
    await websocket.send(event.to_json())
```

### 3. LLM呼び出し

```python
from agentflow.providers import get_llm

llm = get_llm()  # 環境変数から自動検出
response = await llm.chat([{"role": "user", "content": "hello"}])
```

---

## 📝 コードスタイル規範

### 命名規則

```python
# モジュール: snake_case
# agent_flow.py ✅

# クラス: PascalCase
class AgentFlowEngine: ...  # ✅

# 関数/変数: snake_case
def create_agent() -> Agent: ...  # ✅

# 定数: UPPER_SNAKE_CASE
MAX_RETRIES = 3  # ✅

# プライベート: _prefix
self._internal_state: dict = {}  # ✅
```

### 型アノテーション（100%必須）

```python
async def execute_workflow(
    workflow_id: str,
    inputs: dict[str, Any],
    hooks: list[Callable[[str], Awaitable[None]]] | None = None,
) -> dict[str, Any]:
    ...
```

### Docstring（Googleスタイル）

```python
async def execute_workflow(workflow_id: str) -> dict[str, Any]:
    """指定されたワークフローを実行する。

    Args:
        workflow_id: ワークフローの一意識別子

    Returns:
        実行結果を含む辞書

    Raises:
        WorkflowNotFoundError: ワークフローが見つからない場合
    """
```

---

## 🚨 エラーハンドリング

### 例外階層

```
AgentFlowError
├── WorkflowError
│   ├── WorkflowNotFoundError
│   └── WorkflowExecutionError
├── ProtocolError
├── AgentBlockError
└── ConfigurationError
```

### ベストプラクティス

```python
# ✅ 特定例外をキャッチ + raise from
try:
    result = await execute_workflow(workflow_id)
except WorkflowNotFoundError:
    logger.error(f"Workflow not found: {workflow_id}")
    raise
except httpx.HTTPError as e:
    raise WorkflowError("Failed to fetch") from e

# ❌ 広範な例外キャッチは禁止
except Exception:
    pass
```

---

## 🧪 テスト規範

```python
import pytest
from agentflow.core.agent_block import AgentBlock

class TestAgentBlock:
    @pytest.fixture
    def concrete_agent(self) -> type[AgentBlock]:
        class ConcreteAgent(AgentBlock):
            async def run(self, input_data: dict) -> dict:
                return {"result": "ok"}
        return ConcreteAgent

    @pytest.mark.asyncio
    async def test_run(self, concrete_agent: type[AgentBlock]) -> None:
        agent = concrete_agent()
        result = await agent.run({"text": "hello"})
        assert result["result"] == "ok"
```

---

## ❌ 禁止事項

| 禁止 | 代替 |
|------|------|
| `print()` | `logging` |
| `Any` 型（理由なし） | 具体型 |
| `type: ignore` | 型修正 |
| `def foo(x=[])` | `x: list | None = None` |
| ハードコード | 環境変数 |
| `--no-verify` | 禁止 |
| `except Exception` | 特定例外 |

---

## ✅ コミット前チェック

```bash
ruff format . && ruff check . && mypy . && pytest
```

---

## 📚 AIがよく犯す間違い

### ❌ async/await 忘れ
```python
# ❌
def load_data():
    return aiofiles.open("data.txt")

# ✅
async def load_data() -> str:
    async with aiofiles.open("data.txt") as f:
        return await f.read()
```

### ❌ 可変デフォルト引数
```python
# ❌
def add_item(item: str, items: list = []) -> list:
    items.append(item)
    return items

# ✅
def add_item(item: str, items: list | None = None) -> list:
    if items is None:
        items = []
    items.append(item)
    return items
```

### ❌ リソース閉じ忘れ
```python
# ✅ async with を使用
async with aiofiles.open(path) as f:
    return await f.read()
```

### ❌ 循環インポート
```python
# ✅ TYPE_CHECKING を使用
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from b import B

class A:
    def use_b(self, b: "B") -> None: ...
```

---

## 🔄 コミットメッセージ

```
feat: 新機能
fix: バグ修正
docs: ドキュメント
refactor: リファクタリング
test: テスト
chore: ビルド/ツール
```

---

**この規範を厳格に遵守し、コード品質を確保してください！**
