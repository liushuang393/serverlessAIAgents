# æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ³¨æ„: è‡ªå‹•å®Ÿè¡Œã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆworkflow_dispatchã®ã¿ï¼‰
# æ‰‹å‹•å®Ÿè¡Œã®ã¿ã‚’è¨±å¯ã—ã¦ã„ã¾ã™

name: Deploy to Production

# è‡ªå‹•å®Ÿè¡Œã‚’ç„¡åŠ¹åŒ–: workflow_dispatchã®ã¿ã‚’è¨­å®šï¼ˆæ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼‰
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - 'staging'
          - 'production'
      deploy_redis:
        description: 'Redisã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      deploy_postgres:
        description: 'PostgreSQLã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      deploy_vector_db:
        description: 'ãƒ™ã‚¯ãƒˆãƒ«DBã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      run_migrations:
        description: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PYTHON_VERSION: "3.13"

jobs:
  # ã‚¸ãƒ§ãƒ–1: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
  pre-deploy-check:
    name: Pre-deployment Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run all tests
        run: |
          pytest tests/ -v --cov=agentflow --cov-report=term-missing
      
      - name: Check environment variables
        run: |
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "Redis: ${{ github.event.inputs.deploy_redis }}"
          echo "PostgreSQL: ${{ github.event.inputs.deploy_postgres }}"
          echo "Vector DB: ${{ github.event.inputs.deploy_vector_db }}"
          echo "Migrations: ${{ github.event.inputs.run_migrations }}"
      
      - name: Validate deployment configuration
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # ã‚¸ãƒ§ãƒ–2: Redisãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-redis:
    name: Deploy Redis
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: ${{ github.event.inputs.deploy_redis == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Deploy Redis
        run: |
          echo "ğŸš€ Redisã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
          # ä¾‹: docker-compose up -d redis
          echo "âœ… Redisãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

  # ã‚¸ãƒ§ãƒ–3: PostgreSQLãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-postgres:
    name: Deploy PostgreSQL
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: ${{ github.event.inputs.deploy_postgres == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Deploy PostgreSQL
        run: |
          echo "ğŸš€ PostgreSQLã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
          # ä¾‹: docker-compose up -d postgres
          echo "âœ… PostgreSQLãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

  # ã‚¸ãƒ§ãƒ–4: ãƒ™ã‚¯ãƒˆãƒ«DBãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-vector-db:
    name: Deploy Vector Database
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: ${{ github.event.inputs.deploy_vector_db == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Deploy Vector Database
        run: |
          echo "ğŸš€ ãƒ™ã‚¯ãƒˆãƒ«DBã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
          # ä¾‹: docker-compose up -d qdrant
          echo "âœ… ãƒ™ã‚¯ãƒˆãƒ«DBãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

  # ã‚¸ãƒ§ãƒ–5: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-postgres]
    if: ${{ github.event.inputs.run_migrations == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run migrations
        run: |
          echo "ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          # å®Ÿéš›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
          # ä¾‹: alembic upgrade head
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

  # ã‚¸ãƒ§ãƒ–6: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œç¢ºèª
  post-deploy-check:
    name: Post-deployment Check
    runs-on: ubuntu-latest
    needs: [deploy-redis, deploy-postgres, deploy-vector-db, run-migrations]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Health check
        run: |
          echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          # å®Ÿéš›ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
          # ä¾‹: curl http://your-api-endpoint/health
          echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
      
      - name: Deployment summary
        run: |
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "Redis: ${{ github.event.inputs.deploy_redis }}"
          echo "PostgreSQL: ${{ github.event.inputs.deploy_postgres }}"
          echo "Vector DB: ${{ github.event.inputs.deploy_vector_db }}"
          echo "Migrations: ${{ github.event.inputs.run_migrations }}"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†"

