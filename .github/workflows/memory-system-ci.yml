# è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# æ³¨æ„: è‡ªå‹•å®Ÿè¡Œã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆworkflow_dispatchã®ã¿ï¼‰
# æ‰‹å‹•å®Ÿè¡Œã®ã¿ã‚’è¨±å¯ã—ã¦ã„ã¾ã™

name: Memory System CI/CD

# è‡ªå‹•å®Ÿè¡Œã‚’ç„¡åŠ¹åŒ–: workflow_dispatchã®ã¿ã‚’è¨­å®šï¼ˆæ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼‰
on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_lint:
        description: 'Lintã‚’å®Ÿè¡Œã™ã‚‹'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      deploy_enabled:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PYTHON_VERSION: "3.13"

jobs:
  # ã‚¸ãƒ§ãƒ–1: Lintï¼ˆé™çš„è§£æï¼‰
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_lint == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run Ruff (format check)
        run: |
          ruff format --check .
      
      - name: Run Ruff (lint)
        run: |
          ruff check .
      
      - name: Run mypy (type check)
        run: |
          mypy agentflow

  # ã‚¸ãƒ§ãƒ–2: ãƒ†ã‚¹ãƒˆï¼ˆå˜ä½“ãƒ†ã‚¹ãƒˆ + çµ±åˆãƒ†ã‚¹ãƒˆï¼‰
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    if: ${{ github.event.inputs.run_tests == 'true' }}
    
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.13"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run memory system tests
        run: |
          pytest tests/memory/ -v --cov=agentflow.memory --cov-report=xml --cov-report=term-missing
      
      - name: Run distributed memory tests
        run: |
          pytest tests/memory/distributed/ -v --cov=agentflow.memory.distributed --cov-report=xml --cov-report=term-missing
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: memory-system
          name: memory-system-coverage
          fail_ci_if_error: false

  # ã‚¸ãƒ§ãƒ–3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_tests == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit safety
      
      - name: Run pip-audit (dependency vulnerability scan)
        run: |
          pip-audit
        continue-on-error: true
      
      - name: Run bandit (code security scan)
        run: |
          bandit -r agentflow/ -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Upload bandit report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: bandit-report.json

  # ã‚¸ãƒ§ãƒ–4: ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
  # æ³¨æ„: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: ${{ github.event.inputs.deploy_enabled == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy notification
        run: |
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."
          echo "æ³¨æ„: å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã«å®Ÿè£…ã—ã¦ãã ã•ã„"
      
      # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã¯ã“ã“ã«è¿½åŠ 
      # ä¾‹: SSHæ¥ç¶šã€Docker pushã€Kubernetes apply ãªã©

