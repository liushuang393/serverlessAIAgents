# ==============================================================================
# å†åˆ©ç”¨å¯èƒ½ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: Hugging Face Spaces ãƒ‡ãƒ—ãƒ­ã‚¤
# ==============================================================================
name: Reusable Deploy to Hugging Face Spaces

on:
  workflow_call:
    inputs:
      space-name:
        description: "Space å (username/space-name)"
        required: true
        type: string
      space-sdk:
        description: "Space SDK (gradio, streamlit, docker)"
        required: false
        default: "gradio"
        type: string
      working-directory:
        description: "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
        required: false
        default: "."
        type: string
    secrets:
      HF_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Create Space README
        working-directory: ${{ inputs.working-directory }}
        run: |
          cat > README.md << 'EOF'
          ---
          title: ${{ inputs.space-name }}
          emoji: ðŸ¤–
          colorFrom: blue
          colorTo: purple
          sdk: ${{ inputs.space-sdk }}
          sdk_version: "4.0"
          app_file: app.py
          pinned: false
          ---

          # ${{ inputs.space-name }}

          Deployed with AgentFlow Framework via GitHub Actions.
          EOF

      - name: Push to Hugging Face Spaces
        working-directory: ${{ inputs.working-directory }}
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # HF Space ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone https://huggingface.co/spaces/${{ inputs.space-name }} hf-space || \
            (huggingface-cli repo create ${{ inputs.space-name }} --type space --space_sdk ${{ inputs.space-sdk }} && \
             git clone https://huggingface.co/spaces/${{ inputs.space-name }} hf-space)

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          rsync -av --exclude='.git' --exclude='hf-space' --exclude='__pycache__' . hf-space/

          # ãƒ—ãƒƒã‚·ãƒ¥
          cd hf-space
          git add .
          git diff --staged --quiet || git commit -m "Deploy from GitHub Actions: ${{ github.sha }}"
          git push https://oauth2:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ inputs.space-name }} main

