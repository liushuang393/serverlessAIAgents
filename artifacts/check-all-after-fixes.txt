========================================
すべてのチェックを実行中...
========================================

========================================
コードを自動フォーマット中...
========================================

[Python] Ruff フォーマット中...
13 files reformatted, 1166 files left unchanged
[Python] Ruff 自動修正中 (safe fixes)...
TC003 Move standard library import `collections.abc.Iterator` into a type-checking block
  --> agentflow/core/tool_binding.py:24:29
   |
22 | from __future__ import annotations
23 |
24 | from collections.abc import Iterator
   |                             ^^^^^^^^
25 | from typing import TYPE_CHECKING, Any
   |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Iterator` into a type-checking block
  --> agentflow/flow/graph.py:13:29
   |
12 | import logging
13 | from collections.abc import Iterator
   |                             ^^^^^^^^
14 | from typing import TYPE_CHECKING
   |
help: Move into type-checking block

TC003 Move standard library import `enum.Enum` into a type-checking block
  --> agentflow/hitl/api.py:24:18
   |
23 | import logging
24 | from enum import Enum
   |                  ^^^^
25 | from typing import TYPE_CHECKING, Any
   |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.AsyncIterator` into a type-checking block
  --> agentflow/orchestration/monitor.py:25:29
   |
23 | import asyncio
24 | import logging
25 | from collections.abc import AsyncIterator
   |                             ^^^^^^^^^^^^^
26 | from dataclasses import dataclass, field
27 | from datetime import datetime
   |
help: Move into type-checking block

RET503 Missing explicit `return` at the end of function able to return non-`None` value
   --> agentflow/runtime/quota_manager.py:162:5
    |
160 |           return f"{quota_type.value}:{period.value}"
161 |
162 | /     def _get_reset_time(self, period: QuotaPeriod) -> float:
163 | |         """获取重置时间."""
164 | |         now = time.time()
165 | |         if period == QuotaPeriod.MINUTE:
166 | |             return now + 60
167 | |         if period == QuotaPeriod.HOUR:
168 | |             return now + 3600
169 | |         if period == QuotaPeriod.DAY:
170 | |             return now + 86400
171 | |         if period == QuotaPeriod.MONTH:
172 | |             return now + 2592000  # 30天
    | |________________________________^
173 |
174 |       def _get_limit(self, quota_type: QuotaType, period: QuotaPeriod) -> int:
    |
help: Add explicit `return` statement

TC003 Move standard library import `builtins` into a type-checking block
  --> agentflow/sandbox/manager.py:31:8
   |
30 | import asyncio
31 | import builtins
   |        ^^^^^^^^
32 | import logging
33 | from datetime import UTC, datetime
   |
help: Move into type-checking block

TRY400 Use `logging.exception` instead of `logging.error`
   --> agentflow/security/auth_client/client.py:131:13
    |
129 |             )
130 |         except ImportError:
131 |             logger.error("PyJWT がインストールされていません: pip install pyjwt")
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
132 |             return None
133 |         except Exception as e:
    |
help: Replace with `exception`

TRY400 Use `logging.exception` instead of `logging.error`
   --> agentflow/security/auth_client/client.py:151:13
    |
149 |             import httpx
150 |         except ImportError:
151 |             logger.error("httpx がインストールされていません: pip install httpx")
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
152 |             return None
    |
help: Replace with `exception`

EM102 Exception must not use an f-string literal, assign to variable first
   --> agentflow/security/auth_client/client.py:208:17
    |
207 |               raise NotImplementedError(
208 | /                 "プロキシルーターは httpx の StreamingResponse が必要です。"
209 | |                 "本番環境ではリバースプロキシ (Nginx/Traefik) を使用することを推奨します。"
210 | |                 f"auth_service URL: {base_url}"
    | |_______________________________________________^
211 |               )
    |
help: Assign to variable; remove f-string literal

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
  --> agentflow/security/auth_client/dependencies.py:9:29
   |
 8 | import logging
 9 | from collections.abc import Callable
   |                             ^^^^^^^^
10 | from typing import Any
   |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Awaitable` into a type-checking block
  --> agentflow/security/auth_client/middleware.py:10:29
   |
 9 | import logging
10 | from collections.abc import Awaitable, Callable
   |                             ^^^^^^^^^
11 | from typing import Any
   |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
  --> agentflow/security/auth_client/middleware.py:10:40
   |
 9 | import logging
10 | from collections.abc import Awaitable, Callable
   |                                        ^^^^^^^^
11 | from typing import Any
   |
help: Move into type-checking block

TC002 Move third-party import `starlette.requests.Request` into a type-checking block
  --> agentflow/security/auth_client/middleware.py:14:32
   |
13 | from starlette.middleware.base import BaseHTTPMiddleware
14 | from starlette.requests import Request
   |                                ^^^^^^^
15 | from starlette.responses import Response
   |
help: Move into type-checking block

TC002 Move third-party import `starlette.responses.Response` into a type-checking block
  --> agentflow/security/auth_client/middleware.py:15:33
   |
13 | from starlette.middleware.base import BaseHTTPMiddleware
14 | from starlette.requests import Request
15 | from starlette.responses import Response
   |                                 ^^^^^^^^
16 |
17 | from agentflow.security.auth_client.client import AuthClient
   |
help: Move into type-checking block

TC001 Move application import `agentflow.security.auth_client.client.AuthClient` into a type-checking block
  --> agentflow/security/auth_client/middleware.py:17:51
   |
15 | from starlette.responses import Response
16 |
17 | from agentflow.security.auth_client.client import AuthClient
   |                                                   ^^^^^^^^^^
   |
help: Move into type-checking block

RET503 Missing explicit `return` at the end of function able to return non-`None` value
   --> agentflow/security/policy_engine.py:247:5
    |
245 |       # =========================================================================
246 |
247 | /     async def authorize(
248 | |         self,
249 | |         context: AuthContext,
250 | |         mode: AuthMode | str = AuthMode.RBAC,
251 | |     ) -> AuthResult:
252 | |         """認可を実行.
253 | |
254 | |         Args:
255 | |             context: 認可コンテキスト
256 | |             mode: 認可モード（rbac/abac/pbac/hybrid）
257 | |
258 | |         Returns:
259 | |             認可結果
260 | |         """
261 | |         if isinstance(mode, str):
262 | |             mode = AuthMode(mode)
263 | |
264 | |         self._logger.debug(f"認可実行: mode={mode}, action={context.action}")
265 | |
266 | |         if mode == AuthMode.RBAC:
267 | |             return await self._authorize_rbac(context)
268 | |         if mode == AuthMode.ABAC:
269 | |             return await self._authorize_abac(context)
270 | |         if mode == AuthMode.PBAC:
271 | |             return await self._authorize_pbac(context)
272 | |         if mode == AuthMode.HYBRID:
273 | |             return await self._authorize_hybrid(context)
    | |________________________________________________________^
274 |
275 |       async def _authorize_rbac(self, context: AuthContext) -> AuthResult:
    |
help: Add explicit `return` statement

TC003 Move standard library import `collections.abc.Iterator` into a type-checking block
  --> agentflow/skills/builtin/bi_analytics/connector.py:12:29
   |
10 | import logging
11 | from abc import ABC, abstractmethod
12 | from collections.abc import Iterator
   |                             ^^^^^^^^
13 | from dataclasses import dataclass, field
14 | from enum import Enum
   |
help: Move into type-checking block

TRY400 Use `logging.exception` instead of `logging.error`
   --> apps/auth_service/core/jwt.py:257:13
    |
255 |             )
256 |         except ImportError:
257 |             logger.error("PyJWT がインストールされていません")
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
258 |             return None
259 |         except Exception as e:
    |
help: Replace with `exception`

TRY400 Use `logging.exception` instead of `logging.error`
  --> apps/auth_service/core/mfa.py:80:13
   |
78 |             return totp.verify(code, valid_window=1)
79 |         except ImportError:
80 |             logger.error("pyotp がインストールされていません")
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
81 |             return False
82 |         except Exception as e:
   |
help: Replace with `exception`

EM102 Exception must not use an f-string literal, assign to variable first
  --> apps/auth_service/providers/__init__.py:53:22
   |
51 |         return ProxyAuthProvider(settings=settings)
52 |
53 |     raise ValueError(f"未知の認証プロバイダー: {provider_name}")
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
help: Assign to variable; remove f-string literal

TRY400 Use `logging.exception` instead of `logging.error`
  --> apps/auth_service/providers/azure_ad.py:83:13
   |
81 |             import httpx
82 |         except ImportError:
83 |             logger.error("httpx がインストールされていません: pip install httpx")
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
84 |             return None
   |
help: Replace with `exception`

TRY400 Use `logging.exception` instead of `logging.error`
  --> apps/auth_service/providers/google.py:84:13
   |
82 |             import httpx
83 |         except ImportError:
84 |             logger.error("httpx がインストールされていません: pip install httpx")
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
85 |             return None
   |
help: Replace with `exception`

TRY400 Use `logging.exception` instead of `logging.error`
  --> apps/auth_service/providers/ldap.py:77:13
   |
75 |             import ldap3  # type: ignore[import-not-found]
76 |         except ImportError:
77 |             logger.error("ldap3 がインストールされていません: pip install ldap3")
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
78 |             return None
   |
help: Replace with `exception`

SIM105 Use `contextlib.suppress(json.JSONDecodeError, AttributeError)` instead of `try`-`except`-`pass`
   --> apps/auth_service/providers/ldap.py:150:9
    |
148 |           """
149 |           role_mapping: dict[str, Any] = {}
150 | /         try:
151 | |             role_mapping = json.loads(self._settings.LDAP_ROLE_MAPPING)
152 | |         except (json.JSONDecodeError, AttributeError):
153 | |             pass
    | |________________^
154 |
155 |           resolved = self._settings.LDAP_DEFAULT_ROLE
    |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(json.JSONDecodeError, AttributeError): ...`

F401 `onelogin.saml2.auth.OneLogin_Saml2_Auth` imported but unused; consider using `importlib.util.find_spec` to test for availability
  --> apps/auth_service/providers/saml.py:69:45
   |
67 |         """
68 |         try:
69 |             from onelogin.saml2.auth import OneLogin_Saml2_Auth  # type: ignore[import-not-found]
   |                                             ^^^^^^^^^^^^^^^^^^^
70 |         except ImportError:
71 |             logger.error("python3-saml がインストールされていません: pip install python3-saml")
   |
help: Remove unused import: `onelogin.saml2.auth.OneLogin_Saml2_Auth`

TRY400 Use `logging.exception` instead of `logging.error`
  --> apps/auth_service/providers/saml.py:71:13
   |
69 |             from onelogin.saml2.auth import OneLogin_Saml2_Auth  # type: ignore[import-not-found]
70 |         except ImportError:
71 |             logger.error("python3-saml がインストールされていません: pip install python3-saml")
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
72 |             return None
   |
help: Replace with `exception`

F841 Local variable `jti` is assigned to but never used
   --> apps/auth_service/service.py:188:9
    |
186 |         user_id = str(claims.get("sub", ""))
187 |         family = str(claims.get("family", ""))
188 |         jti = str(claims.get("jti", ""))
    |         ^^^
189 |
190 |         token_hash = self._pwd.hash_token(refresh_token)
    |
help: Remove assignment to unused variable `jti`

Found 77 errors (50 fixed, 27 remaining).
No fixes available (26 hidden fixes can be enabled with the `--unsafe-fixes` option).
ERROR conda.cli.main_run:execute(142): `conda run ruff check --fix .` failed. (See above for error)
[警告] safe fixes 後に未修正エラーが残っています (lint で確認されます)
[Python] Ruff 自動修正中 (unsafe fixes)...
ERROR conda.cli.main_run:execute(142): `conda run ruff check --unsafe-fixes --fix .` failed. (See above for error)
F401 `onelogin.saml2.auth.OneLogin_Saml2_Auth` imported but unused; consider using `importlib.util.find_spec` to test for availability
  --> apps/auth_service/providers/saml.py:69:45
   |
67 |         """
68 |         try:
69 |             from onelogin.saml2.auth import OneLogin_Saml2_Auth  # type: ignore[import-not-found]
   |                                             ^^^^^^^^^^^^^^^^^^^
70 |         except ImportError:
71 |             logger.exception("python3-saml がインストールされていません: pip install python3-saml")
   |
help: Remove unused import: `onelogin.saml2.auth.OneLogin_Saml2_Auth`

Found 39 errors (38 fixed, 1 remaining).

[JS/TS format] apps/faq_system/frontend -> npm run lint -- --fix (fallback)

/home/liush/workspase/serverlessAIAgents/apps/faq_system/frontend/src/i18n/I18nProvider.tsx
  16:10  error  Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components  react-refresh/only-export-components

✖ 1 problem (1 error, 0 warnings)

[警告][JS/TS format] apps/faq_system/frontend fallback 自動修正で未解決エラーがあります
[JS/TS format] studio -> npm run format

✅ フォーマット処理が完了しました

========================================
リントチェック中...
========================================

[Python] Ruff リントチェック中...
ERROR conda.cli.main_run:execute(142): `conda run ruff check .` failed. (See above for error)
F401 `onelogin.saml2.auth.OneLogin_Saml2_Auth` imported but unused; consider using `importlib.util.find_spec` to test for availability
  --> apps/auth_service/providers/saml.py:69:45
   |
67 |         """
68 |         try:
69 |             from onelogin.saml2.auth import OneLogin_Saml2_Auth  # type: ignore[import-not-found]
   |                                             ^^^^^^^^^^^^^^^^^^^
70 |         except ImportError:
71 |             logger.exception("python3-saml がインストールされていません: pip install python3-saml")
   |
help: Remove unused import: `onelogin.saml2.auth.OneLogin_Saml2_Auth`

Found 1 error.
[エラー] Ruff リントチェックに失敗しました
[分類][Ruff] ルール上位:
      1 F401

========================================
型チェック中...
========================================

[Python] MyPy 型チェック中... (targets: agentflow)
ERROR conda.cli.main_run:execute(142): `conda run mypy agentflow --ignore-missing-imports` failed. (See above for error)
agentflow/security/policy_engine.py:274:9: error: Statement is unreachable 
[unreachable]
            return None
            ^~~~~~~~~~~
agentflow/runtime/quota_manager.py:173:9: error: Statement is unreachable 
[unreachable]
            return None
            ^~~~~~~~~~~
Found 2 errors in 2 files (checked 603 source files)
[エラー] MyPy 型チェックに失敗しました
[分類][MyPy] エラーコード上位:
      2 unreachable
[分類][MyPy] ファイル上位:
    1 agentflow/security/policy_engine.py
    1 agentflow/runtime/quota_manager.py
[分析][MyPy] 自動修復可否:
  - 半自動で対応可能: import-untyped（types-* stub 追加）
  - 自動修復困難: call-arg / arg-type / assignment / union-attr / override / no-any-return
    -> これらは型定義・実装整合性の修正が必要

========================================
セキュリティチェック中 (bandit)...
========================================

[Python] bandit SAST チェック中...
[main]	INFO	profile include tests: None
[main]	INFO	profile exclude tests: None
[main]	INFO	cli include tests: None
[main]	INFO	cli exclude tests: None
[main]	INFO	running on Python 3.13.11
[tester]	WARNING	nosec encountered (B701), but no failed test on line 72
[tester]	WARNING	nosec encountered (B701), but no failed test on line 72
[tester]	WARNING	nosec encountered (B701), but no failed test on line 60
[tester]	WARNING	nosec encountered (B701), but no failed test on line 60
Working... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:08
Run started:2026-02-21 12:22:53.916505+00:00

Test results:
	No issues identified.

Code scanned:
	Total lines of code: 135055
	Total lines skipped (#nosec): 0
	Total potential issues skipped due to specifically being disabled (e.g., #nosec BXXX): 3

Run metrics:
	Total issues (by severity):
		Undefined: 0
		Low: 40
		Medium: 28
		High: 0
	Total issues (by confidence):
		Undefined: 0
		Low: 16
		Medium: 24
		High: 28
Files skipped (0):

✅ セキュリティチェックが完了しました

========================================
テストを実行中 (unit tests)...
========================================

Terminated
[エラー] テストに失敗しました
[分類][pytest] 失敗テスト上位:
[分析][pytest] 自動修復可否:
  - 自動修復困難: テスト失敗は実装修正かfixture調整が必要

========================================
❌ 一部チェックで失敗しました
失敗ステップ: lint type-check test
========================================
