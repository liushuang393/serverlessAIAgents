# 📌 AgentFlow Code Rules インデックス

> **プロジェクト**: AgentFlow - MCP/A2A/AG-UI/A2UI 統一インターフェース AI エージェントフレームワーク
> **バージョン**: 1.0.0
> **最終更新**: 2026-01-19
> **適用範囲**: AgentFlow 全 Python コードベース

## 🧠 全体方針（Global）

- [開発原則](global/principles.md)
- [命名規則](global/naming-guidelines.md)
- [スタイル & フォーマット](global/style-formatting.md)
- [例外/エラー処理](global/error-handling.md)
- [AI弱点補強](global/ai-weakness.md)

## 🧠 言語別ルール

- [Pythonルール](languages/python-rules.md)

## 🧠 プロジェクト固有

- [アーキテクチャ設計](project/architecture.md)
- [リポジトリ構造](project/repo-structure.md)
- [CI/CDガイドライン](project/ci-cd-guidelines.md)

## 🧠 AgentFlow固有指針

- [AgentFlow Python](company-specific/agentflow-python.md)

## 🧠 使用ツール

- [リンター & フォーマッター](tools/lint-format.md)
- [テスト方針](tools/testing.md)

---

## 🎯 AgentFlow プロジェクト概要

**AgentFlow** は MCP / A2A / AG-UI / A2UI の 4 プロトコルを統一インターフェースで扱う軽量 AI エージェント開発フレームワークです。

### 主要特徴
- **8層アーキテクチャ**: アプリ・UI・フロー・Agent・ツール・Provider・プロトコル・インフラの明確分離
- **統一プロトコル**: 4つの標準プロトコルを1つのAPIで利用
- **非同期優先**: すべてのI/Oをasync/await前提で設計
- **型安全**: 100%型アノテーション、mypyとRuffを標準化
- **Skills自動進化**: 使えば使うほど賢くなる自動学習システム

### 開発方式
- **@agentデコレータ**: 1行でAgent定義、設定ゼロ
- **create_flow**: 宣言的チェーンAPI、Gate/Review/並行実行
- **AgentCoordinator**: 完全制御、高度な協調パターン
- **Engine Pattern**: 配置即用、4種類の予定義パターン

### 技術スタック
- **言語**: Python 3.13+
- **アーキテクチャ**: 8層クリーンアーキテクチャ
- **プロトコル**: MCP, A2A, AG-UI, A2UI
- **インフラ**: Supabase/PostgreSQL/Turso, Pinecone/Qdrant, Redis
- **品質**: Ruff, mypy, pytest, 92% カバレッジ

### 品質基準
- **型安全**: 100% 型アノテーション必須
- **テスト**: pytest + カバレッジ 80% 以上（目標 90%）
- **フォーマット**: Ruff 統一（format + lint）
- **ドキュメント**: Google スタイル Docstring

---

## 📋 ルール適用ガイド

### 優先順位
1. **プロジェクト固有ルール** - AgentFlow のアーキテクチャ特性を反映
2. **言語別ルール** - Python 生態系のベストプラクティス
3. **グローバルルール** - 普遍的な開発原則

### 自動化チェック
```bash
# コミット前必須チェック
ruff format .                    # フォーマット
ruff check .                     # リント
mypy agentflow                   # 型チェック
pytest --cov=agentflow --cov-fail-under=80  # テスト
```

### AI生成コードの品質保証
- **仕様明文化テンプレート**強制
- **100%テストカバレッジ**要求
- **命名意図検証**と**エラー処理完全性確認**

---

## 🔍 コンプライアンス確認

### 自動化チェックリスト

#### コミット前チェック (Pre-commit)
- [ ] `ruff format .` - コードフォーマット
- [ ] `ruff check .` - リントチェック
- [ ] `mypy agentflow` - 型チェック
- [ ] `pytest --cov=agentflow --cov-fail-under=80` - テスト実行
- [ ] `pre-commit run --all-files` - 全自動チェック

#### マージ前チェック (Pre-merge)
- [ ] すべての自動化チェック通過
- [ ] 最低 1 名のレビュー承認
- [ ] 関連ドキュメント更新済み
- [ ] 破壊的変更は移行ガイドを添付

#### リリース前チェック (Pre-release)
- [ ] すべての統合テスト通過
- [ ] セキュリティスキャン完了
- [ ] パフォーマンス/ストリーミング動作検証
- [ ] ロールバック手順確認

### 品質ゲート

| 段階 | 品質基準 | 責任者 |
|------|---------|--------|
| **コードコミット** | Ruff/Mypy/Tests 通過 | 開発者 |
| **機能完了** | 統合テスト、ドキュメント更新 | 機能責任者 |
| **リリース準備** | CI/CD 全通過、セキュリティスキャン | リリース担当 |

各ルールファイルには具体的なチェック項目と自動化スクリプトが記載されています。

# グローバル設定（AI 共通ルール）

## 基本原則
- AI は補助的意思決定者であり、最終判断は行わない
- 不確実な場合は必ず明示する
- 推測・捏造は禁止する

## 言語設定
- 回答は日本語で行う
- コードコメントは日本語を使用する

## 出力規則
- 原則として構造化された形式で出力する
- 複雑な内容は段階的に説明する
- 出力の最後に次のアクションを示す

## モジュラー設計ルール
## 基本原則

**すべてのソースファイルは1000行未満に保つこと。**

## ファイルサイズ制限

| ファイル種別 | 推奨行数 | 最大行数 |
|-------------|---------|---------|
| コンポーネント/クラス | 200-300行 | 500行 |
| ユーティリティ/ヘルパー | 100-200行 | 300行 |
| 設定ファイル | 50-100行 | 200行 |
| テストファイル | 300-500行 | 800行 |
| **絶対上限** | - | **1000行** |

## 分割基準

ファイルが以下の条件に該当する場合、分割を検討すること：

1. **行数超過**: 500行を超えた時点で分割を計画
2. **責務過多**: 1ファイルに3つ以上の責務が混在
3. **依存過多**: インポート文が20行を超える
4. **関数過多**: 1ファイルに10個以上の公開関数/メソッド
## 実装時の指示

### コード生成時
- 新規ファイル作成時は300行以内を目標とする
- 500行を超える場合は分割案を提示してから実装
- 1000行を超えるファイルは絶対に作成しない

### リファクタリング時
- 既存の大規模ファイルを発見したら分割を提案
- 分割時は既存の動作を壊さないよう段階的に実施
- テストを先に書いてから分割作業を行う

## 安全・責任
- 違法・侵害行為に関わる出力は禁止
- 承認・署名・契約行為を代行しない
