# 開発原則

> **バージョン**: 1.0.0
> **適用範囲**: AgentFlow 全開発プロセス
> **最終更新**: 2026-01-19

## 📋 目次

1. [品質優先（Quality First）](#品質優先quality-first)
2. [漸進的改善（Incremental Progress）](#漸進的改善incremental-progress)
3. [実用主義（Pragmatic Approach）](#実用主義pragmatic-approach)
4. [明確な意図（Clear Intent）](#明確な意図clear-intent)
5. [シンプル優先（Simplicity First）](#シンプル優先simplicity-first)
6. [可逆性（Reversibility）](#可逆性reversibility)

---
# グローバル設定（AI 共通ルール）

## 基本原則
- AI は補助的意思決定者であり、最終判断は行わない
- 不確実な場合は必ず明示する
- 推測・捏造は禁止する

## 言語設定
- 回答は日本語で行う
- コードコメントは日本語を使用する

## 出力規則
- 原則として構造化された形式で出力する
- 複雑な内容は段階的に説明する
- 出力の最後に次のアクションを示す

## モジュラー設計ルール
## 基本原則

**すべてのソースファイルは1000行未満に保つこと。**

## ファイルサイズ制限

| ファイル種別 | 推奨行数 | 最大行数 |
|-------------|---------|---------|
| コンポーネント/クラス | 200-300行 | 500行 |
| ユーティリティ/ヘルパー | 100-200行 | 300行 |
| 設定ファイル | 50-100行 | 200行 |
| テストファイル | 300-500行 | 800行 |
| **絶対上限** | - | **1000行** |

## 分割基準

ファイルが以下の条件に該当する場合、分割を検討すること：

1. **行数超過**: 500行を超えた時点で分割を計画
2. **責務過多**: 1ファイルに3つ以上の責務が混在
3. **依存過多**: インポート文が20行を超える
4. **関数過多**: 1ファイルに10個以上の公開関数/メソッド
## 実装時の指示

### コード生成時
- 新規ファイル作成時は300行以内を目標とする
- 500行を超える場合は分割案を提示してから実装
- 1000行を超えるファイルは絶対に作成しない

### リファクタリング時
- 既存の大規模ファイルを発見したら分割を提案
- 分割時は既存の動作を壊さないよう段階的に実施
- テストを先に書いてから分割作業を行う

## 安全・責任
- 違法・侵害行為に関わる出力は禁止
- 承認・署名・契約行為を代行しない


## 🎯 品質優先（Quality First）

### 型・リントのゼロトレランス
- **必須**: mypy/ruff エラーは一切許容しない
- **自動化**: `check.sh all` / `pre-commit` をコミット前に必須実行
- **品質メトリクス**: テストカバレッジ 80% 以上、目標 90%+

```bash
# ✅ 必須の品質チェック
ruff format .                    # フォーマット統一
ruff check .                     # リントチェック
mypy agentflow                   # 型チェック
pytest --cov=agentflow --cov-fail-under=80  # カバレッジチェック
```

### 自動化可能な品質ゲート
- **コミット前**: 全自動チェック通過必須
- **マージ前**: 最低1名のレビュー承認 + 全自動チェック
- **リリース前**: 統合テスト + セキュリティスキャン

---

## 🔄 漸進的改善（Incremental Progress）

### 段階的改善アプローチ
- **既存構造尊重**: 互換性を保ちながら改善
- **技術的負債管理**: TODO/課題は必ず Issue で管理・可視化

```python
# ✅ 改善例: 新しい型を段階的に導入
# 段階1: 既存コードはそのまま
def process_data(data: dict) -> dict:
    pass

# 段階2: 新規コードに型を適用
def process_data_v2(data: dict[str, Any]) -> dict[str, Any]:
    pass
```

### 技術的負債の追跡
- **Issue 管理**: 技術的負債は `[tech-debt]` ラベルで管理
- **優先度設定**: 影響度 × 頻度 で優先度を決定
- **定期見直し**: 四半期ごとに負債削減計画を策定

---

## 🛠️ 実用主義（Pragmatic Approach）

### 実装優先のバランス
- **プロトコル互換性**: MCP/A2A/AG-UI/A2UI の相互運用を確保
- **開発効率**: 8層アーキテクチャ内で責務を明確に限定
- **過度な抽象化回避**: 実装より理解しやすさを優先

```python
# ✅ 実用主義: シンプルな統一インターフェース
from agentflow import get_llm, get_db, get_vectordb

# 環境変数から自動検出 - プロバイダー具体名不要
llm = get_llm()          # OpenAI/Anthropic/Google 自動選択
db = get_db()            # Supabase/PostgreSQL/Turso 自動選択
vdb = get_vectordb()     # Pinecone/Qdrant 自動選択
```

### 抽象化のガイドライン
- **8層以内**: 各層の責務を厳格に分離
- **インターフェース優先**: 実装より契約を重視
- **設定より規約**: 明示的な設定より暗黙の了解を優先

---

## 🎯 明確な意図（Clear Intent）

### 命名で意図を示す
- **Protocol/Service/Executor/Builder**: 役割を命名で明示
- **README/ガイド/Docstring**: 整合性を維持

```python
# ✅ 明確な命名: 役割が一目でわかる
class CodeGenerator:         # 生成器
class DeployExecutor:        # 実行器
class ConfigManager:         # 管理器
class WorkflowRunner:        # 実行器

# ❌ 曖昧な命名: 何をするのかわからない
class Processor:            # 何を処理する？
class Handler:              # 何を扱う？
class Manager:              # 何を管理？
```

### ドキュメント同期
- **README**: プロジェクト概要と使用方法
- **API ドキュメント**: インターフェース仕様
- **コードコメント**: なぜこの実装なのかを説明

---

## 🎪 シンプル優先（Simplicity First）

### 小さく焦点を絞る
- **単一責務**: Agent/Tool は1つのことだけをする
- **保守性**: 6ヶ月後に理解できる構造を重視

```python
# ✅ シンプル: 単一責務のAgent
@agent
class QAAgent:
    """質問応答のみを担当"""

    async def run(self, question: str) -> str:
        # 質問応答ロジックのみ
        pass

# ❌ 複雑: 複数の責務を持つAgent
@agent
class ComplexAgent:
    """QA + 検索 + 分析 + レポート生成"""
    # 複数の責任が混在 - 保守性が低い
```

### 複雑さの測定
- **循環複雑度**: 10以下を目安
- **クラス責務**: 5メソッド以内
- **関数長**: 50行以内

---

## 🔄 可逆性（Reversibility）

### 後方互換の最優先
- **Core Interface Layer**: 安定した契約を維持
- **移行パス**: 破壊的変更時は移行ガイドを提供

```python
# ✅ 可逆性: インターフェースの安定性
class ICodeGenerator(Protocol):
    """安定したインターフェース契約"""

    async def generate(self, workflow: WorkflowDefinition) -> GeneratedCode:
        """コード生成 - 署名は変更しない"""
        ...

    async def preview(self, workflow: WorkflowDefinition) -> CodeOutput:
        """プレビュー - 新規メソッドは追加のみ"""
        ...
```

### ロールバック戦略
- **デプロイ**: 青緑デプロイメントで即時ロールバック可能
- **生成物**: 再現可能な形で保持
- **設定**: バージョン管理された設定ファイル

---

## ✅ 原則遵守チェック

### 自動チェック項目
- [ ] mypy エラーなし（型安全）
- [ ] ruff check 通過（品質基準）
- [ ] テストカバレッジ 80%以上
- [ ] 循環複雑度 10以下
- [ ] Docstring 100% カバー

### 手動レビュー項目
- [ ] 命名が意図を明確に示しているか
- [ ] 責務が単一で明確か
- [ ] 抽象化レベルが適切か
- [ ] 後方互換性が保たれているか

---

## 📞 原則適用時の判断基準

| 原則 | 優先度 | 判断基準 | 例 |
|------|--------|----------|-----|
| **品質優先** | 🔴 高 | エラーが残るか | mypy エラーは修正必須 |
| **漸進的改善** | 🟡 中 | 既存コードを壊すか | 互換性を保ちつつ改善 |
| **実用主義** | 🟡 中 | 開発効率 vs 理想 | プロトコル互換を優先 |
| **明確な意図** | 🟡 中 | コードが自己文書化されているか | 命名で役割がわかる |
| **シンプル優先** | 🟢 低 | 理解しやすさ vs 機能 | 小さな関数を優先 |
| **可逆性** | 🟢 低 | 変更が戻せるか | インターフェース安定を優先 |

*最終更新: 2026-01-19 | AgentFlow 8層アーキテクチャ対応*